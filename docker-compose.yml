version: '3'

services:
  govsso-mock:
    build:
      context: .
      dockerfile: build/Dockerfile
    image: govsso-mock
    networks:
      default:
        aliases:
          - govsso-mock.localhost
    ports:
      - '10443:10443'
    volumes:
      - ./config:/govsso-mock/config:ro

  client:
    image: ghcr.io/e-gov/govsso-client:0.6.1
    entrypoint: bash -c 'sleep 5 && /cnb/process/web'
    depends_on:
      - govsso-mock
    deploy:
      resources:
        limits:
          memory: 650M
    environment:
      - server.port=11443
      - spring.application.name=Client
      - govsso.client-id=example-client-id
      - govsso.client-secret=secret-a
      - govsso.redirect-uri=https://client.localhost:11443/login/oauth2/code/govsso
      - govsso.post-logout-redirect-uri=https://client.localhost:11443/?show-post-logout-message
      - govsso.issuer-uri=https://govsso-mock.localhost:10443/
      - govsso.trust-store=file:/var/certs/client.localhost.truststore.p12
      - govsso.trust-store-password=changeit
      - example-client.logo=client-a.svg
      - server.ssl.key-store-type=PKCS12
      - server.ssl.key-store=/var/certs/client.localhost.keystore.p12
      - server.ssl.key-store-password=changeit
      - BPL_JVM_THREAD_COUNT=10
    networks:
      default:
        aliases:
          - client.localhost
    ports:
      - '11443:11443'
    restart: unless-stopped
    volumes:
      - ./config/tls/client/client.localhost.keystore.p12:/var/certs/client.localhost.keystore.p12:ro
      - ./config/tls/client/client.localhost.truststore.p12:/var/certs/client.localhost.truststore.p12:ro
